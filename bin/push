#!/usr/bin/env bash

# -e  Exit immediately if a command exits with a non-zero status.
set -e

if [ -z "$REGISTRY_HOST" ] || [[ "$REGISTRY_HOST" == *"docker.io"* ]]; then
  docker login -u "$REGISTRY_USERNAME" -p "$REGISTRY_PASSWORD"
else
  docker login -u "$REGISTRY_USERNAME" -p "$REGISTRY_PASSWORD" "$REGISTRY_HOST"
fi

docker images

# Why was the code assuming that $REPO:$TAG exists
# while $REPO:latest doesn't and not vice versa?

docker tag $REPO:latest $REPO:$TAG
docker push $REPO:$TAG

echo "Updating latest tag"
docker push $REPO:latest

if [ -z "$REGISTRY_HOST" ] || [[ "$REGISTRY_HOST" == *"docker.io"* ]]; then
  docker logout
else
  docker logout "$REGISTRY_HOST"
fi
